<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="stylesheet" href="./Resources/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./Resources/Roboto/Roboto-Regular.ttf">
    <link rel="stylesheet" href="./Resources/bootstrap.min.css">

    <style>
        body {
            margin: 0px;
            padding: 0px;
            width: 1200px;
            font-family: 'Roboto', sans-serif;
            background-color: #f1f1f1;
        }

        .panel-row {
            margin: 10px;
            width: 1180px;
            display: flex;
        }

            .panel-row > .custom-panel {
                margin: 0px;
            }

                .panel-row > .custom-panel:not(:last-child) {
                    margin-right: 10px;
                }

                .panel-row > .custom-panel:not(:first-child) {
                    margin-left: 10px;
                }

        .custom-panel {
            margin: 10px;
            padding: 10px;
            background-color: white;
            display: inline-block;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.16),0 2px 10px 0 rgba(0,0,0,0.12);
        }

            .custom-panel > * {
                margin: 0px;
            }

        .summary-item {
            display: inline-block;
            padding: 12px;
            padding-top: 7px;
            padding-bottom: 7px;
            border-radius: 5px;
            margin-left: 10px;
            margin-bottom: 5px;
        }

        i {
            cursor: pointer;
            font-size: 26px !important;
        }

        #day-breakdown-summary {
            margin-left: 70px;
            max-height: 90px;
            overflow-y: auto;
        }

        .menu {
            display: flex;
            background-color: white;
        }

        .menu-item {
            width: calc(100% /3);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

            .menu-item:not(:first-child) {
                border-left: 1px solid #f1f1f1;
            }


            .menu-item:hover {
                background-color: rgba(241, 241, 241, 0.5);
            }

        .active {
            background-color: #f1f1f1;
        }

        .custom-container {
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
    <title></title>
</head>
<body>
    <div class="menu">
        <div class="menu-item active" id="overview-menu" onclick="changeWindow(0);"><h3>Overview</h3></div>
        <div class="menu-item" id="details-menu" onclick="changeWindow(1);"><h3>Reports</h3></div>
        <div class="menu-item" id="calendar-menu" onclick="changeWindow(2);"><h3>Calendar</h3></div>
    </div>
    <div class="custom-container" id="overview">
        <div class="custom-panel" style="width: 1180px; display: flex; justify-content: center; margin-top: 0px;">
            <div style="width: 600px; display: flex; justify-content: space-between; align-items: center;">
                <i onclick="changeDate(-1)" class="fa fa-chevron-left" aria-hidden="true"></i>
                <h3 style="margin: 0px; padding: 0px;" id="date-text" data-value="0">Today</h3>
                <i onclick="changeDate(1)" class="fa fa-chevron-right" aria-hidden="true"></i>
            </div>
        </div>
        <div class="custom-panel" style="width: 1180px">
            <h3>Day Breakdown</h3>
            <canvas id="day-breakdown" height="50"></canvas>
            <div id="day-breakdown-summary"></div>
        </div>
        <div class="panel-row" style="margin-bottom: 0px;">
            <div class="custom-panel" style="width: 50%; margin-bottom: 0px;">
                <h3>Activities (<span id="week"></span>)</h3>
                <canvas id="activities"></canvas>
            </div>
            <div class="custom-panel" style="width: 50%; margin-bottom: 0px;">
                <h3>Apps (that day)</h3>
                <canvas id="windows"></canvas>
            </div>
        </div>
    </div>
    <div class="custom-container" id="details" style="display: none;">
        <div class="custom-panel" style="width: 1180px; display: flex; justify-content: center; margin-top: 0px;">
            <h3>
                <select id="time-select">
                    <option>This weeks</option>
                    <option>Last weeks</option>
                    <option>This months</option>
                    <option>Last weeks</option>
                </select>
                <span> report for </span>
                <select id="activities-select"></select>
            </h3>

        </div>
    </div>
    <div class="custom-container" id="calendar" style="display: none;">
        calendar
    </div>
    <script src="./Resources/Chart.bundle.min.js"></script>
    <script src="./Resources/chartjs-plugin-datalabels.min.js"></script>
    <script src="./Resources/hammer.min.js"></script>
    <script src="./Resources/chartjs-plugin-zoom.js"></script>
    <script>
        var backgroundColor = [
            '#0074D9',
            '#7FDBFF',
            '#39CCCC',
            '#3D9970',
            '#2ECC40',
            '#01FF70',
            '#FFDC00',
            '#FF851B',
            '#FF4136',
            '#85144b',
            '#F012BE',
            '#B10DC9',
        ];

        var data = [];
        var data2 = [];
        var data3 = [];

        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff));
        }

        function getDateString(d) {
            return d.getDate() + "." + (d.getMonth() + 1) + "." + d.getFullYear();
        }

        function changeWindow(window) {
            switch (window) {
                case 0:
                    var value = parseInt(document.getElementById('date-text').dataset.value);
                    update(value);
                    document.getElementById('details').style.display = 'none';
                    document.getElementById('calendar').style.display = 'none';
                    document.getElementById('overview').style.display = 'block';

                    document.querySelector('.active').classList.remove('active');
                    document.getElementById('overview-menu').classList.add('active');
                    break;
                case 1:
                    document.getElementById('overview').style.display = 'none';
                    document.getElementById('calendar').style.display = 'none';
                    document.getElementById('details').style.display = 'block';

                    document.querySelector('.active').classList.remove('active');
                    document.getElementById('details-menu').classList.add('active');
                    break;
                case 2:
                    document.getElementById('overview').style.display = 'none';
                    document.getElementById('details').style.display = 'none';
                    document.getElementById('calendar').style.display = 'block';

                    document.querySelector('.active').classList.remove('active');
                    document.getElementById('calendar-menu').classList.add('active');
                    break;
            }
        }

        async function update(value) {
            var today = new Date();
            today.setDate(today.getDate() + value);

            if (typeof boundAsync === "undefined")
                await CefSharp.BindObjectAsync("boundAsync");

            boundAsync.getOverviewData(value).then(function (result) {
                var resultParsed = JSON.parse(result);
                data = resultParsed.overview;
                data2 = resultParsed.windows;
                data3 = resultParsed.activities;

                stackedBar.data = {
                    labels: [getDateString(today)],
                    datasets: prepareActivityBreakdown()
                };

                var monday = getMonday(today);
                var sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                document.getElementById('week').innerHTML = getDateString(monday) + " - " + getDateString(sunday);

                myDoughnutChart.data = prepareWindows();

                myBarChart.data = prepareActivities();
                myBarChart.options.scales.yAxes[0].ticks.max = data3.reduce((p, c) => p = Math.max(c.value, p), 0) * 1.15;
                stackedBar.update();
                drawSummary();
                myDoughnutChart.update();
                myBarChart.update();
            });
        }

        function changeDate(change) {
            var value = parseInt(document.getElementById('date-text').dataset.value);
            value += change;
            document.getElementById('date-text').dataset.value = value;

            switch (value) {
                case 0:
                    document.getElementById('date-text').innerHTML = "Today";
                    break;
                case 1:
                    document.getElementById('date-text').innerHTML = "Tomorrow";
                    break;
                case -1:
                    document.getElementById('date-text').innerHTML = "Yesterday";
                    break;
                default:
                    var today = new Date();
                    today.setDate(today.getDate() + value);
                    document.getElementById('date-text').innerHTML = today.toDateString();
            }

            update(value);
        }

        function prepareActivityBreakdown() {
            var result = [];
            var colorPosition = [];

            if (data.length === 0) {
                result.push({
                    fill: false,
                    data: [
                        24
                    ]
                });

                return result;
            }

            result.push({
                fill: false,
                data: [
                    data[0].from
                ]
            });

            for (var i = 0; i < data.length; i++) {
                result.push({
                    label: data[i].name,
                    backgroundColor: backgroundColor[colorPosition.indexOf(data[i].name) < 0 ? colorPosition.push(data[i].name) - 1 : colorPosition.indexOf(data[i].name)],
                    data: [
                        data[i].to - data[i].from
                    ]
                });

                if (i + 1 < data.length) {
                    result.push({
                        fill: false,
                        data: [
                            data[i + 1].from - data[i].to
                        ]
                    });
                } else {
                    result.push({
                        fill: false,
                        data: [
                            24 - data[i].to
                        ]
                    });
                }
            }

            return result;
        }

        var ctx = document.getElementById("day-breakdown").getContext('2d');

        var stackedBar = new Chart(ctx, {
            type: 'horizontalBar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                scales: {
                    xAxes: [{
                        stacked: true,
                        ticks: {
                            max: 24,
                            min: 0,
                            //stepSize: 2,
                            callback: function (value, index, values) {
                                //return value <= 12 ? Math.round(value * 100) / 100 + "AM" : ((Math.round((value - 12) * 100) / 100)) + "PM";
                                var hours = 0;
                                var minutes = 0;

                                while (value >= 1) {
                                    hours++;
                                    value--;
                                }

                                minutes = Math.round(60 * value);

                                return hours + ":" + ('0' + minutes).slice(-2);
                            }
                        },
                        position: "top"
                    }],
                    yAxes: [{
                        stacked: true
                    }]
                },
                legend: {
                    display: false
                },
                tooltips: {
                    mode: 'point',
                    filter: function (tooltipItem, data) {
                        var label = data.datasets[tooltipItem.datasetIndex].label;

                        return label !== undefined
                    },
                    callbacks: {
                        label: function (tooltipItem, data) {
                            var label = data.datasets[tooltipItem.datasetIndex].label;

                            label += " (" + formatTime(tooltipItem.xLabel) + ")";
                            return label;
                        },
                        title: function (tooltipItem, data) {
                            return null;
                        }
                    }
                },
                hover: {
                    mode: 'point',
                },
                pan: {
                    enabled: true,
                    mode: 'x', // is panning about the y axis neccessary for bar charts?
                    rangeMin: {
                        // Format of min pan range depends on scale type
                        x: 0,
                        y: null
                    },
                    rangeMax: {
                        // Format of max pan range depends on scale type
                        x: 24,
                        y: null
                    },
                },
                zoom: {
                    enabled: true,
                    mode: 'x',
                    sensitivity: 3,
                    rangeMin: {
                        // Format of max zoom range depends on scale type
                        x: 0,
                        y: null
                    },
                    rangeMax: {
                        // Format of max zoom range depends on scale type
                        x: 24,
                        y: null
                    }
                },
                plugins: {
                    datalabels: {
                        display: false
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        function formatTime(totlaHours) {
            var hours = 0;
            var minutes = 0;

            while (totlaHours >= 1) {
                hours++;
                totlaHours--;
            }

            minutes = Math.round(60 * totlaHours);

            return hours + "h " + minutes + "m";
        }

        function drawSummary() {
            var result = {};

            var innerHTML = "<div style='display: inline-block;'>Activity : </div>";

            for (var i = 0; i < data.length; i++) {
                if (result[data[i].name] === undefined)
                    result[data[i].name] = data[i].to - data[i].from;
                else
                    result[data[i].name] += data[i].to - data[i].from;
            }

            var counter = 0;

            Object.keys(result).forEach(function (key) {
                innerHTML += "<div class='summary-item' style='background-color: " + backgroundColor[counter++] + ";'>" + key + " (" + formatTime(result[key]) + ")" + "</div>";
            });

            document.getElementById("day-breakdown-summary").innerHTML = innerHTML;
        }

        drawSummary();

        function prepareActivities() {
            var result = {};
            var colorPosition = [];

            result["labels"] = [];
            result["datasets"] = [{
                data: [],
                backgroundColor: [],
                label: "Dataset 1"
            }];

            for (var i = 0; i < data3.length; i++) {
                result["labels"].push(data3[i].name);
                result["datasets"][0]["data"].push(data3[i].value);
                result["datasets"][0]["backgroundColor"].push(backgroundColor[colorPosition.indexOf(data3[i].name) < 0 ? colorPosition.push(data3[i].name) - 1 : colorPosition.indexOf(data3[i].name)]);
            }

            return result;
        }

        ctx = document.getElementById("activities").getContext('2d');

        var myBarChart = new Chart(ctx, {
            type: 'bar',
            data: {},
            options: {
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem, data) {
                            var label = data.labels[tooltipItem.index];

                            label += " (" + formatTime(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]) + ")";
                            return label;
                        }
                    }
                },
                scales: {
                    yAxes: [{
                        display: false,
                        ticks: {
                            min: 0
                        }
                    }]
                },
                legend: {
                    display: false
                },
                layout: {
                    padding: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    }
                },
                plugins: {
                    datalabels: {
                        anchor: "end",
                        align: "top",
                        formatter: function (value, context) {
                            return formatTime(value);
                        }
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        function prepareWindows() {
            var result = {};
            var colorPosition = [];

            result["labels"] = [];
            result["datasets"] = [{
                data: [],
                backgroundColor: [],
                label: "Dataset 1"
            }];

            for (var i = 0; i < data2.length; i++) {
                result["labels"].push(data2[i].name);
                result["datasets"][0]["data"].push(data2[i].value);
                result["datasets"][0]["backgroundColor"].push(backgroundColor[colorPosition.indexOf(data2[i].name) < 0 ? colorPosition.push(data2[i].name) - 1 : colorPosition.indexOf(data2[i].name)]);
            }

            return result;
        }

        ctx = document.getElementById("windows").getContext('2d');

        var myDoughnutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {},
            options: {
                legend: {
                    position: 'right',
                    labels: {
                        generateLabels: function (chart) {
                            var data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function (label, i) {
                                    var meta = chart.getDatasetMeta(0);
                                    var ds = data.datasets[0];
                                    var arc = meta.data[i];
                                    var custom = arc && arc.custom || {};
                                    var getValueAtIndexOrDefault = Chart.helpers.getValueAtIndexOrDefault;
                                    var arcOpts = chart.options.elements.arc;
                                    var fill = custom.backgroundColor ? custom.backgroundColor : getValueAtIndexOrDefault(ds.backgroundColor, i, arcOpts.backgroundColor);
                                    var stroke = custom.borderColor ? custom.borderColor : getValueAtIndexOrDefault(ds.borderColor, i, arcOpts.borderColor);
                                    var bw = custom.borderWidth ? custom.borderWidth : getValueAtIndexOrDefault(ds.borderWidth, i, arcOpts.borderWidth);

                                    // We get the value of the current label
                                    var value = chart.config.data.datasets[arc._datasetIndex].data[arc._index];

                                    return {
                                        // Instead of `text: label,`
                                        // We add the value to the string
                                        text: (label.length > 30 ? label.substr(0, 30) + "..." : label) + " (" + formatTime(value) + ")",
                                        fillStyle: fill,
                                        strokeStyle: stroke,
                                        lineWidth: bw,
                                        hidden: isNaN(ds.data[i]) || meta.data[i].hidden,
                                        index: i
                                    };
                                });
                            } else {
                                return [];
                            }
                        }
                    }
                },
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem, data) {
                            var label = data.labels[tooltipItem.index].length > 30 ? data.labels[tooltipItem.index].substr(0, 30) + "..." : data.labels[tooltipItem.index];

                            label += " (" + formatTime(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index]) + ")";
                            return label;
                        }
                    }
                },
                plugins: {
                    datalabels: {
                        display: false
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        async function populateSelect() {
            if (typeof boundAsync === "undefined")
                await CefSharp.BindObjectAsync("boundAsync");

            boundAsync.getDetailsData1().then(function (result) {
                var resultParsed = JSON.parse(result).activities;

                var html = "";

                for (var i = 0; i < resultParsed.length; i++) {
                    html += "<option>" + resultParsed[i] + "</option>";
                }

                document.getElementById('activities-select').innerHTML = html;
            });
        }

        update(0);
        populateSelect();
    </script>
</body>
</html>